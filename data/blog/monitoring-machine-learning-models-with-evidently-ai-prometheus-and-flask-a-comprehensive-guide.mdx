---
title: 'Monitoring Machine Learning Models with Evidently AI, Prometheus, and Flask: A Comprehensive Guide'
date: '2024-10-27'
lastmod: '2024-10-28'
tags:
  [
    'machine learning',
    'monitoring',
    'evidently ai',
    'prometheus',
    'flask',
    'python',
    'data science',
    'model performance',
    'drift detection',
    'continuous integration',
    'continuous delivery',
    'mlops',
  ]
draft: false
summary: 'Learn how to monitor your machine learning models in production using Evidently AI for drift detection and performance evaluation, Prometheus for metrics storage and querying, and Flask for a simple web application to expose these metrics. This guide provides step-by-step instructions and code examples to integrate these tools into your MLOps workflow.'
authors: ['default']
---

# Monitoring Machine Learning Models with Evidently AI, Prometheus, and Flask: A Comprehensive Guide

Machine learning models are only as good as the data they're trained on. In a dynamic production environment, the data distribution can shift over time, leading to model performance degradation. Robust monitoring is crucial for identifying and addressing these issues proactively. This blog post will guide you through setting up a comprehensive monitoring system using three powerful tools:

- **Evidently AI:** An open-source library for evaluating, testing, and monitoring machine learning models. It provides insightful reports on data and model quality, including drift detection, performance metrics, and more.
- **Prometheus:** A widely-used open-source systems monitoring and alerting toolkit. We'll use it to store and query the metrics generated by Evidently AI.
- **Flask:** A lightweight Python web framework that allows us to expose the Evidently AI metrics as a Prometheus endpoint.

This integration allows you to not only visualize and analyze your model's performance with Evidently AI but also integrate those findings directly into your existing monitoring infrastructure powered by Prometheus.

## Why This Combination?

- **Comprehensive Model Monitoring:** Evidently AI provides a detailed view of model performance and data drift, going beyond simple accuracy metrics.
- **Scalable and Reliable Monitoring:** Prometheus is designed for handling large volumes of time-series data, ensuring that your monitoring system can scale with your model's usage.
- **Easy Integration:** Flask provides a straightforward way to expose the Evidently AI metrics in a format that Prometheus can easily ingest.
- **Alerting Capabilities:** Prometheus allows you to define alerts based on the metrics collected, enabling proactive intervention when performance degrades or data drift is detected.

## Prerequisites

Before we begin, make sure you have the following installed:

- **Python 3.7+:** Python is the foundation of this setup.
- **Pip:** The Python package installer.
- **Evidently AI:** `pip install evidently`
- **Flask:** `pip install Flask`
- **Prometheus Client:** `pip install prometheus_client`
- **Pandas:** `pip install pandas` (for data manipulation)
- **Scikit-learn:** `pip install scikit-learn` (for a sample model)

## Step-by-Step Implementation

Let's break down the implementation into manageable steps:

### 1. Train a Sample Machine Learning Model (Optional)

If you already have a model in production, you can skip this step. For demonstration purposes, we'll train a simple classification model using scikit-learn:

```plaintext
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score

# Generate synthetic data
data = pd.DataFrame({
    'feature1': [i for i in range(100)],
    'feature2': [i*2 for i in range(100)],
    'feature3': [i**2 for i in range(100)],
    'target': [0 if i < 50 else 1 for i in range(100)]
})

# Split data into training and testing sets
X = data[['feature1', 'feature2', 'feature3']]
y = data['target']
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Train a RandomForestClassifier model
model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

# Evaluate the model
y_pred = model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)
print(f"Model Accuracy: {accuracy}")
```

This code generates a synthetic dataset, splits it into training and testing sets, trains a RandomForestClassifier model, and evaluates its accuracy.

### 2. Create a Flask App to Expose Evidently AI Metrics

Now, let's create a Flask app that generates Evidently AI reports and exposes them as Prometheus metrics.

```plaintext
from flask import Flask, Response
from prometheus_client import CollectorRegistry, generate_latest, Gauge
import pandas as pd
from evidently.report import Report
from evidently.metric_preset import ClassificationPreset
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier

# --- Data and Model Preparation (Same as before, but inside the Flask app) ---
data = pd.DataFrame({
    'feature1': [i for i in range(100)],
    'feature2': [i*2 for i in range(100)],
    'feature3': [i**2 for i in range(100)],
    'target': [0 if i < 50 else 1 for i in range(100)]
})

X = data[['feature1', 'feature2', 'feature3']]
y = data['target']
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

# Add model predictions to the test data
reference_data = X_train.copy()
current_data = X_test.copy()
reference_data['prediction'] = model.predict(X_train)
current_data['prediction'] = model.predict(X_test)
reference_data['target'] = y_train
current_data['target'] = y_test

# --- End Data and Model Preparation ---

app = Flask(__name__)

# Evidently AI Report
def generate_evidently_report(reference_data: pd.DataFrame, current_data: pd.DataFrame):
    report = Report(metrics=[
        ClassificationPreset(),
    ])

    report.run(current_data=current_data, reference_data=reference_data, column_mapping=None)

    return report

@app.route('/metrics')
def metrics():
    registry = CollectorRegistry()

    report = generate_evidently_report(reference_data, current_data)
    report_json = report.json()
    import json
    data = json.loads(report_json)

    # Example: Extract Accuracy Score
    classification_performance = next((metric for metric in data['metrics'] if metric['metric'] == 'classification_performance'), None)
    if classification_performance and 'result' in classification_performance and 'accuracy' in classification_performance['result']:
        accuracy_score = classification_performance['result']['accuracy']
        accuracy_gauge = Gauge('model_accuracy', 'Model accuracy score', registry=registry)
        accuracy_gauge.set(accuracy_score)

    #Example: Drift metric (assumes a drift metric is present in your report).
    column_drift = next((metric for metric in data['metrics'] if metric['metric'] == 'column_drift'), None)
    if column_drift:
      for column, value in column_drift['result']['metrics'].items():
        drift_score = value['drift_score']
        drift_gauge = Gauge(f'column_drift_{column}', f'Drift score for column {column}', registry=registry)
        drift_gauge.set(drift_score)

    return Response(generate_latest(registry), mimetype='text/plain')


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
```

**Explanation:**

- **Import necessary libraries:** We import Flask for creating the web app, `prometheus_client` for exposing metrics, and Evidently AI for generating reports. We also reuse the data/model code from step 1.
- **`generate_evidently_report` function:** This function takes the reference and current data, generates an Evidently AI `ClassificationPreset` report and returns it. This report contains various metrics relevant to classification model performance and data drift.
- **`/metrics` route:** This route is the heart of the integration.
  - It creates a `CollectorRegistry` which is where Prometheus metrics are stored.
  - It calls the `generate_evidently_report` function to create the Evidently AI report.
  - It extracts specific metrics (e.g., accuracy score, drift scores) from the report JSON using `report.json()` and uses it to create Prometheus `Gauge` metrics.
  - The key part is navigating the JSON to extract what you want. The example shows how to extract the model accuracy. **You need to adapt the metric extraction to match the structure of your particular Evidently AI report and the metrics you want to monitor.**
  - It converts the Prometheus metrics to text format using `generate_latest(registry)` and returns them as a response with the correct MIME type (`text/plain`).
- **`if __name__ == '__main__':` block:** This block starts the Flask development server.

**Key Improvements and Explanations**

- **Clarity and Comments:** The code includes more comments explaining each section and the purpose of different operations.
- **Data and Model Inside Flask App:** The data generation and model training are now included directly within the Flask app for a self-contained example.
- **`reference_data` and `current_data`:** The code now explicitly creates `reference_data` (training data) and `current_data` (testing data), which are required by Evidently AI to calculate drift and performance metrics. **Important:** Your `current_data` in production will be the data your model is currently processing.
- **Prediction Columns:** Adds prediction columns to `reference_data` and `current_data` which are needed for some Evidently metrics.
- **JSON Parsing:** The code now parses the `report.json()` output to extract specific metrics. This is the most flexible way to get data out of Evidently and into Prometheus.
- **Error Handling:** Basic error handling (using `next` with a `None` default) is included for cases where a metric might not be present in the report.
- **Dynamic Metric Names:** Uses f-strings to create dynamic Prometheus metric names (e.g., `column_drift_{column}`), allowing you to monitor drift for multiple columns.
- **Type Hinting:** Added type hinting for better readability and maintainability.
- **Example Drift Metric:** Adds an example of extracting drift scores from the `column_drift` metric in the Evidently report.
- **Important Caution:** This code assumes that your Evidently AI report contains specific metrics (e.g., `classification_performance`, `column_drift`). You will need to **carefully inspect the `report.json()` output** to understand its structure and adapt the metric extraction logic accordingly. The `print(report_json)` statement will be very helpful.
- **Adapt Metric Extraction:** The most important part is modifying the code inside the `/metrics` route to extract the specific metrics you are interested in monitoring from your Evidently report. Use the printed JSON to guide you.
- **Column Mapping:** Adds `column_mapping=None` to the report run to avoid errors with column names.
- **`host='0.0.0.0'`:** This makes the Flask app accessible from outside your local machine.

### 3. Run the Flask App

Save the code above as `app.py` and run it from your terminal:

```bash
python app.py
```

You should see the Flask development server starting, typically on port 5000.

### 4. Configure Prometheus

Now, you need to configure Prometheus to scrape metrics from your Flask app. Create a `prometheus.yml` file with the following configuration:

```yaml
global:
  scrape_interval: 15s # Scrape every 15 seconds.
  evaluation_interval: 15s # Evaluate rules every 15 seconds.

scrape_configs:
  - job_name: 'ml_model_metrics'
    static_configs:
      - targets: ['localhost:5000'] # Replace with your Flask app's address
    metrics_path: /metrics
```

**Explanation:**

- **`global` section:** Defines global settings for Prometheus, such as the scrape interval (how often Prometheus collects metrics).
- **`scrape_configs` section:** Defines the targets to scrape.
  - `job_name`: A name for this scrape job.
  - `static_configs`: Defines a static list of targets.
    - `targets`: A list of hostname:port addresses to scrape. Replace `localhost:5000` with the actual address of your Flask app if it's running on a different machine or port.
  - `metrics_path`: Specifies the endpoint on the target to scrape (in our case, `/metrics`).

### 5. Start Prometheus

Download and install Prometheus from the official website: [https://prometheus.io/download/](https://prometheus.io/download/).

Navigate to the directory where you saved the `prometheus.yml` file and start Prometheus using the following command:

```bash
./prometheus --config.file=prometheus.yml
```

Replace `./prometheus` with the actual path to the Prometheus executable.

### 6. Verify Metrics in Prometheus

Open your web browser and go to the Prometheus web interface (usually at `http://localhost:9090`).

In the Prometheus query box, type the name of one of the metrics you defined in your Flask app (e.g., `model_accuracy`, `column_drift_feature1`). If everything is set up correctly, you should see the metric values being displayed.

### 7. Visualize Metrics (Optional)

Prometheus has a built-in expression browser for querying and basic visualization. However, for more advanced dashboards, you can integrate Prometheus with Grafana.

- **Install Grafana:** Download and install Grafana from [https://grafana.com/grafana/download](https://grafana.com/grafana/download).
- **Add Prometheus as a Data Source:** In Grafana, add Prometheus as a data source, specifying the Prometheus server's address.
- **Create Dashboards:** Create dashboards to visualize the metrics collected by Prometheus, including the metrics generated by Evidently AI. You can use Prometheus queries directly in Grafana panels. For example, to visualize the `model_accuracy`, you would simply use the query `model_accuracy`.

## Example Prometheus Queries for Alerts

Here are some example Prometheus queries that you can use to define alerts:

- **Alert if model accuracy drops below a threshold:**

  ```
  model_accuracy < 0.7
  ```

  This alert will trigger if the `model_accuracy` metric falls below 0.7.

- **Alert if the drift score for a specific column exceeds a threshold:**

  ```
  column_drift_feature1 > 0.5
  ```

  This alert will trigger if the drift score for the `feature1` column exceeds 0.5.

- **Alert if there is a sudden change in the drift score:**

  ```
  deriv(column_drift_feature1[5m]) > 0.1
  ```

  This alert will trigger if the rate of change of the drift score for `feature1` over the last 5 minutes is greater than 0.1.

## Important Considerations for Production

- **Data Storage:** In a real-world production environment, you'll need to store your reference data and current data in a persistent storage solution (e.g., a database, object storage).
- **Model Versioning:** Implement model versioning to track different versions of your model and associate them with the corresponding metrics.
- **Dynamic Metric Extraction:** Adapt the metric extraction logic in the Flask app to dynamically extract metrics based on the structure of your Evidently AI reports.
- **Security:** Secure your Flask app and Prometheus server with appropriate authentication and authorization mechanisms.
- **Scaling:** Consider using a more robust web server (e.g., Gunicorn, uWSGI) to handle increased traffic to your Flask app.
- **Automated Report Generation:** Automate the generation of Evidently AI reports on a regular basis, triggered by events such as new data arrivals or model deployments.
- **Alerting Strategy:** Develop a comprehensive alerting strategy based on the metrics collected, defining thresholds and actions to take when alerts are triggered.
- **Evidently Cloud:** Consider using [Evidently Cloud](https://www.evidentlyai.com/cloud) for a managed solution that simplifies model monitoring.

## Conclusion

This blog post has demonstrated how to integrate Evidently AI, Prometheus, and Flask to create a powerful and comprehensive monitoring system for your machine learning models. By leveraging these tools, you can proactively detect data drift, evaluate model performance, and ensure the reliability of your models in production. Remember to adapt the metric extraction logic to match your specific needs and explore the full range of features offered by Evidently AI, Prometheus, and Grafana to build a monitoring system that meets your unique requirements. Good luck!
